<% presenter = CommandRunPresenter.new(command_run) %>
<div class="space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border border-wttj-gray-light p-6">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-4">
        <%= render "shared/status_indicator", presenter: presenter, size: :large %>

        <div>
          <h1 class="text-2xl font-bold text-wttj-black">
            <span class="font-mono"><%= presenter.command %></span>
            <% if presenter.org_ref.present? %>
              <span class="text-wttj-gray-dark font-normal"><%= presenter.org_ref %></span>
            <% end %>
          </h1>
          <div class="flex items-center gap-4 mt-1 text-sm text-wttj-gray-medium">
            <span>Started: <%= presenter.formatted_started_at %></span>
            <% if presenter.formatted_duration %>
              <span>Duration: <%= presenter.formatted_duration %></span>
            <% end %>
            <span class="capitalize font-medium <%= presenter.status_text_color %>">
              <%= presenter.display_status %>
            </span>
          </div>
          <% if presenter.formatted_options.any? %>
            <div class="flex flex-wrap gap-2 mt-2">
              <%= render "shared/options_tags", presenter: presenter %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="flex gap-2">
        <% if presenter.interruptable? %>
          <%= button_to "Interrupt", interrupt_command_path(presenter),
              method: :post,
              data: { turbo_confirm: "Interrupt this command?" },
              class: "text-sm px-3 py-1 rounded border border-orange-300 text-orange-600 hover:bg-orange-50 hover:border-orange-400 transition-colors" %>
        <% end %>
        <% if presenter.finished? %>
          <% if presenter.org_ref.present? %>
            <% export_id = find_export_id_for_org(presenter.org_ref, command_run: command_run) %>
            <% if export_id %>
              <%= link_to "View Export", export_path(export_id),
                  class: "text-sm px-3 py-1 rounded border border-wttj-gray-light hover:border-wttj-yellow transition-colors" %>
            <% else %>
              <%= link_to "View Exports", exports_path,
                  class: "text-sm px-3 py-1 rounded border border-wttj-gray-light hover:border-wttj-yellow transition-colors" %>
            <% end %>
          <% end %>
          <%= link_to "Download ZIP", download_command_path(command_run),
              class: "text-sm px-3 py-1 rounded border border-wttj-gray-light hover:border-wttj-yellow transition-colors" %>
          <% if presenter.org_ref.present? %>
            <%= link_to "Run Again", new_command_path(org_ref: presenter.org_ref, command: presenter.command),
                class: "text-sm bg-wttj-yellow hover:bg-yellow-400 text-wttj-black px-3 py-1 rounded transition-colors" %>
          <% end %>
        <% end %>
        <% if presenter.finished? %>
          <%= button_to "Delete", command_path(presenter),
              method: :delete,
              data: { turbo_confirm: "Delete this command run and its output?" },
              class: "text-sm px-3 py-1 rounded border border-red-300 text-red-600 hover:bg-red-50 hover:border-red-400 transition-colors" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Output -->
  <div class="bg-wttj-black rounded-lg shadow-sm p-4" data-controller="auto-scroll">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-white font-medium">Output</h2>
      <% if presenter.stale? %>
        <span class="text-orange-500 text-sm">Interrupted</span>
      <% elsif presenter.running? %>
        <span class="text-wttj-yellow text-sm animate-pulse">Running...</span>
      <% end %>
    </div>
    <div id="output" data-auto-scroll-target="output" class="text-sm text-wttj-gray-light whitespace-pre-wrap max-h-96 overflow-y-auto"><% if presenter.output.present? %><%= presenter.output.strip %><% elsif presenter.pending? %><span class="text-wttj-gray-medium">Waiting to start...</span><% elsif presenter.running? %><span class="text-wttj-gray-medium">Executing...</span><% else %><span class="text-wttj-gray-medium">No output</span><% end %></div>
  </div>

  <!-- Error -->
  <% if presenter.error.present? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <h2 class="text-red-800 font-medium mb-2">Error</h2>
      <pre class="font-mono text-sm text-red-700 whitespace-pre-wrap"><%= presenter.error %></pre>
    </div>
  <% end %>

  <!-- Generated Output Files -->
  <% if presenter.completed? && presenter.org_ref.present? %>
    <% export_id = find_export_id_for_org(presenter.org_ref, command_run: command_run) %>
    <% export_files = find_export_files_for_org(presenter.org_ref, command_run: command_run) %>
    <% if export_files.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-wttj-gray-light p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium text-wttj-black">Generated Output (<%= export_files.count %> files)</h2>
          <% if export_id %>
            <%= link_to "Browse Files â†’", export_path(export_id),
                class: "text-sm text-wttj-yellow hover:underline" %>
          <% end %>
        </div>
        <div class="flex flex-wrap gap-2">
          <% export_files.first(8).each do |file| %>
            <% if export_id %>
              <%= link_to file_export_path(export_id, path: file[:path]),
                  class: "text-xs font-mono bg-wttj-beige px-2 py-1 rounded hover:bg-wttj-gray-light transition-colors" do %>
                <%= file[:name] %>
              <% end %>
            <% else %>
              <span class="text-xs font-mono bg-wttj-beige px-2 py-1 rounded"><%= file[:name] %></span>
            <% end %>
          <% end %>
          <% if export_files.count > 8 && export_id %>
            <%= link_to export_path(export_id),
                class: "text-xs text-wttj-gray-dark hover:text-wttj-black" do %>
              +<%= export_files.count - 8 %> more
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
