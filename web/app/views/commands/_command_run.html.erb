<div class="space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border border-wttj-gray-light p-6">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-4">
        <% case command_run.display_status %>
        <% when "completed" %>
          <span class="w-4 h-4 bg-green-500 rounded-full"></span>
        <% when "failed" %>
          <span class="w-4 h-4 bg-red-500 rounded-full"></span>
        <% when "running" %>
          <span class="w-4 h-4 bg-wttj-yellow rounded-full animate-pulse"></span>
        <% when "interrupted" %>
          <span class="w-4 h-4 bg-orange-500 rounded-full"></span>
        <% else %>
          <span class="w-4 h-4 bg-wttj-gray-medium rounded-full"></span>
        <% end %>

        <div>
          <h1 class="text-2xl font-bold text-wttj-black">
            <span class="font-mono"><%= command_run.command %></span>
            <% if command_run.org_ref.present? %>
              <span class="text-wttj-gray-dark font-normal"><%= command_run.org_ref %></span>
            <% end %>
          </h1>
          <div class="flex items-center gap-4 mt-1 text-sm text-wttj-gray-medium">
            <span>Started: <%= command_run.started_at&.strftime("%Y-%m-%d %H:%M:%S") || "â€”" %></span>
            <% if command_run.duration %>
              <span>Duration: <%= command_run.duration %>s</span>
            <% end %>
            <span class="capitalize font-medium
              <%= case command_run.display_status
                  when 'completed' then 'text-green-600'
                  when 'failed' then 'text-red-600'
                  when 'running' then 'text-wttj-yellow'
                  when 'interrupted' then 'text-orange-500'
                  else 'text-wttj-gray-dark'
                  end %>">
              <%= command_run.display_status %>
            </span>
          </div>
          <% if command_run.options.present? && command_run.options.any? %>
            <div class="flex flex-wrap gap-2 mt-2">
              <% command_run.options.each do |key, value| %>
                <span class="text-xs bg-wttj-beige px-2 py-0.5 rounded">
                  <span class="text-wttj-gray-dark">--<%= key %>:</span>
                  <span class="font-mono"><%= value.is_a?(Array) ? value.join(", ") : value %></span>
                </span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="flex gap-2">
        <% if command_run.finished? && command_run.org_ref.present? %>
          <% export_id = find_export_id_for_org(command_run.org_ref, command_run: command_run) %>
          <% if export_id %>
            <%= link_to "View Export", export_path(export_id),
                class: "text-sm px-3 py-1 rounded border border-wttj-gray-light hover:border-wttj-yellow transition-colors" %>
          <% else %>
            <%= link_to "View Exports", exports_path,
                class: "text-sm px-3 py-1 rounded border border-wttj-gray-light hover:border-wttj-yellow transition-colors" %>
          <% end %>
          <%= link_to "Run Again", new_command_path(org_ref: command_run.org_ref, command: command_run.command),
              class: "text-sm bg-wttj-yellow hover:bg-yellow-400 text-wttj-black px-3 py-1 rounded transition-colors" %>
        <% end %>
        <% unless command_run.running? %>
          <%= button_to "Delete", command_path(command_run),
              method: :delete,
              data: { turbo_confirm: "Delete this command run and its output?" },
              class: "text-sm px-3 py-1 rounded border border-red-300 text-red-600 hover:bg-red-50 hover:border-red-400 transition-colors" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Output -->
  <div class="bg-wttj-black rounded-lg shadow-sm p-4" data-controller="auto-scroll">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-white font-medium">Output</h2>
      <% if command_run.stale? %>
        <span class="text-orange-500 text-sm">Interrupted</span>
      <% elsif command_run.running? %>
        <span class="text-wttj-yellow text-sm animate-pulse">Running...</span>
      <% end %>
    </div>
    <div id="output" data-auto-scroll-target="output" class="text-sm text-wttj-gray-light whitespace-pre-wrap max-h-96 overflow-y-auto"><% if command_run.output.present? %><%= command_run.output.strip %><% elsif command_run.pending? %><span class="text-wttj-gray-medium">Waiting to start...</span><% elsif command_run.running? %><span class="text-wttj-gray-medium">Executing...</span><% else %><span class="text-wttj-gray-medium">No output</span><% end %></div>
  </div>

  <!-- Error -->
  <% if command_run.error.present? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <h2 class="text-red-800 font-medium mb-2">Error</h2>
      <pre class="font-mono text-sm text-red-700 whitespace-pre-wrap"><%= command_run.error %></pre>
    </div>
  <% end %>

  <!-- Generated Output Files -->
  <% if command_run.completed? && command_run.org_ref.present? %>
    <% export_files = find_export_files_for_org(command_run.org_ref, command_run: command_run) %>
    <% if export_files.any? %>
      <% folders = extract_folders_from_files(export_files) %>
      <div class="bg-white rounded-lg shadow-sm border border-wttj-gray-light" data-controller="file-browser accordion">
        <div class="p-4 border-b border-wttj-gray-light">
          <h2 class="font-medium text-wttj-black mb-2">Generated Output (<%= export_files.count %> files)</h2>
          <nav class="text-sm font-mono" data-file-browser-target="breadcrumb">
            <button type="button" data-action="click->file-browser#navigate" data-path="" class="text-wttj-black font-medium hover:text-wttj-black">root</button>
          </nav>
        </div>
        <div class="divide-y divide-wttj-gray-light">
          <%# Folders %>
          <% folders.each do |folder| %>
            <div data-file-browser-target="folderItem"
                 data-folder-path="<%= folder %>"
                 data-folder-parent="<%= folder_parent(folder) %>"
                 class="<%= folder_parent(folder).present? ? 'hidden' : '' %>">
              <button type="button"
                      data-action="click->file-browser#navigate"
                      data-path="<%= folder %>"
                      class="w-full px-4 py-3 flex items-center justify-between hover:bg-wttj-beige transition-colors text-left">
                <div class="flex items-center gap-3">
                  <svg class="w-4 h-4 text-wttj-yellow" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                  </svg>
                  <span class="font-mono text-sm text-wttj-black"><%= folder.split("/").last %></span>
                </div>
                <svg class="w-4 h-4 text-wttj-gray-medium" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          <% end %>
          <%# Files %>
          <% export_files.each do |file| %>
            <div data-file-browser-target="fileItem"
                 data-file-path="<%= file[:path] %>"
                 data-file-dir="<%= file_directory(file[:path]) %>"
                 class="<%= file_directory(file[:path]).present? ? 'hidden' : '' %>">
              <button type="button"
                      data-action="click->accordion#toggle"
                      class="w-full px-4 py-3 flex items-center justify-between hover:bg-wttj-beige transition-colors text-left">
                <div class="flex items-center gap-3">
                  <svg data-accordion-target="icon" class="w-4 h-4 text-wttj-gray-medium transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  <span class="font-mono text-sm text-wttj-black"><%= file[:name] %></span>
                  <span class="text-xs text-wttj-gray-medium uppercase px-2 py-0.5 bg-wttj-beige rounded"><%= file[:type] %></span>
                </div>
                <span class="text-xs text-wttj-gray-medium"><%= number_to_human_size(file[:size]) %></span>
              </button>
              <div class="hidden px-4 pb-4">
                <% if file[:type] == :markdown %>
                  <div class="prose prose-sm max-w-none bg-white border border-wttj-gray-light rounded-lg p-4 max-h-96 overflow-y-auto">
                    <%= render_file_content(File.read(file[:full_path]), file[:type]) %>
                  </div>
                <% else %>
                  <div class="bg-wttj-black rounded-lg p-4 max-h-96 overflow-y-auto">
                    <pre class="highlight font-mono text-sm leading-relaxed whitespace-pre-wrap break-words"><code><%= raw render_file_content(File.read(file[:full_path]), file[:type]) %></code></pre>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

</div>
